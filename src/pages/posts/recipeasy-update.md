---
title: Personal Project update
date: '2020-10-18'
thumb_img_path: /images/recipeasy-tomato.png
excerpt: Recipeasy has moved homes!
template: post
subtitle: I've migrated away from Azure...
content_img_path: /images/recipeasy-screenshot.png
---

#### Introduction

Originally, when I set out to do my [Recipeasy](https://recipeasy.netlify.app/) personal project last year, I settled on using Azure as my cloud-hosting provider. I am a .NET developer by trade so it made sense for me to do the backend in .NET Core and I knew Azure would have good support for this since they're both Microsoft technologies. There was a steep learning curve but it was no different from AWS in that regard, which is what I was using in my job at the time. It took me a while but I got the site (frontend, backend and database) set up in Azure and never thought anything more about it.

#### Frontend

That was until earlier this year when I decided to give [Netlify](https://www.netlify.com/) a go. I deployed a small site that was auto-generated by [create-nuxt-app](https://github.com/nuxt/create-nuxt-app) and the process was as simple as connecting my GitHub and pointing Netlify to the right repository. In less than a minute, my Nuxt site was deployed and on the world wide web! What was also awesome is that as soon as a commit is pushed to the master branch, it would rebuild and deploy automatically. I did have a similar CI/CD pipeline set up in Azure DevOps for both my front and backend but it took a lot of research and experimentation to get it working properly.

Now, deploying a SPA like an Angular app is slightly more complex than the above in that you have to specify the build command (`ng build --prod` in this case) and specify the location of the build files (`dist/recipeasy`). A `_redirects` [file](https://github.com/aellwood/recipeasy/blob/master/src/_redirects) is also needed so that Netlify knows to allow your SPA router to handle redirects (otherwise Netlify will serve your user a 404 when they try to change page). Still, not exactly a gruelling process!

#### Backend

Long story short, I was very impressed with Netlify but there is a downside: you can't use it to host backend or database services. However, I had also heard good things about another cloud provider: [Heroku](https://www.heroku.com/). Disappointingly, they don't mention C# on their site as a supported language but as it turns out, their service revolves around containers. To get my backend hosted, it was as simple as adding a [Dockerfile](https://github.com/aellwood/recipeasy-api/blob/master/Dockerfile) to my .NET Core repo:

```
# NuGet restore
FROM mcr.microsoft.com/dotnet/core/sdk:3.1 AS build
WORKDIR /src
COPY *.sln .
COPY Recipeasy.Api.Tests/*.csproj Recipeasy.Api.Tests/
COPY Recipeasy.Api/*.csproj Recipeasy.Api/
RUN dotnet restore
COPY . .

# testing
FROM build AS testing
WORKDIR /src/Recipeasy.Api
RUN dotnet build
WORKDIR /src/Recipeasy.Api.Tests
RUN dotnet test

# publish
FROM build AS publish
WORKDIR /src/Recipeasy.Api
RUN dotnet publish -c Release -o /src/publish

FROM mcr.microsoft.com/dotnet/core/aspnet:3.1 AS runtime
WORKDIR /app
COPY --from=publish /src/publish .
# ENTRYPOINT ["dotnet", "Recipeasy.Api.dll"]
# heroku uses the following
CMD ASPNETCORE_URLS=http://*:$PORT dotnet Recipeasy.Api.dll
```


 as well as a [yml file](https://github.com/aellwood/recipeasy-api/blob/master/.github/workflows/main.yml) to configure a GitHub Action for the build/deployment process:
 
 ```
name: HerokuContainer

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - name: Build and deploy the Docker image
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          APP_NAME: ${{ 'recipeasy-api' }}
        run: |
          docker login --username=_ --password=$HEROKU_API_KEY registry.heroku.com
          heroku container:push web -a $APP_NAME
          heroku container:release web -a $APP_NAME
 ```
 
  The final thing necessary was to add my Heroku Api Key to the secrets section of my API repository in GitHub. *Et voil√†!* CI/CD deployment pipeline for Heroku. This was again *much* simpler than using Azure.

#### Database

The final piece of the puzzle was the database. In Azure, I'd been using a NoSQL option: Azure Storage Tables in an Azure Storage Blob. Thankfully, Heroku supports the addition of a PostgreSQL database add-ons to apps. 

This required a significant rework to my source code as my existing implementation was quite heavily coupled to the aforementioned NoSQL Azure database. Fortunately, Entity Framework Core made this process relatively straightforward and I was actually able to remove a significant amount of code and complexity in making this change. 

Though there were some odd things necessary, like this parsing of the connection string provided by Heroku to make it usable by EF:

```
// Use connection string provided at runtime by Heroku.
var connUrl = Environment.GetEnvironmentVariable("DATABASE_URL");

// Parse connection URL to connection string for Npgsql
connUrl = connUrl.Replace("postgres://", string.Empty);
var pgUserPass = connUrl.Split("@")[0];
var pgHostPortDb = connUrl.Split("@")[1];
var pgHostPort = pgHostPortDb.Split("/")[0];
var pgDb = pgHostPortDb.Split("/")[1];
var pgUser = pgUserPass.Split(":")[0];
var pgPass = pgUserPass.Split(":")[1];
var pgHost = pgHostPort.Split(":")[0];
var pgPort = pgHostPort.Split(":")[1];

connStr = $"Server={pgHost};Port={pgPort};User Id={pgUser};Password={pgPass};Database={pgDb}";
```

#### Conclusion

On the whole, I'm really impressed by both Netlify and Heroku and would recommend them wholeheartedly. They really are vastly superior options for hobbyist projects (and probably a lot of pro projects too) thanks to the speed and simplicity with which you can get your apps deployed.  

It's also worth me pointing out that my usage of Netlify/Heroku as outlined here is completely free and even doesn't require the input of any card details - winner! I'd only ever had to pay a few pence on Azure each month but it's settling to know whatever happens, I won't be charged. We've all heard about the bill shock [horror stories](https://dev.to/juanmanuelramallo/i-was-billed-for-14k-usd-on-amazon-web-services-17fn) in relation to cloud hosting providers!

The good thing (or bad thing, depending on your point of view!) is that as a user there has been no functional change to the site other than the URL to access it. Though I do think the response times for the APIs in particular seem significantly faster. 

Anyway, hopefully I'll have another update soon with some new features and/or polish. If you hadn't yet had chance to have a look at Recipeasy in all its glory, please find it [here]((https://recipeasy.netlify.app/)) (although I will warn you it's still very much a work-in-progress). Thanks for reading!

P.S. This site is also hosted on Netlify - more details [here](/about-this-site).

###### Source code links

- [Frontend](https://github.com/aellwood/recipeasy)
- [Backend](https://github.com/aellwood/recipeasy-api)